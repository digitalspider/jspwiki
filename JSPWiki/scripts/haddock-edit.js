Date.extend({toISOString:function(){var e=this,t=e.getDate(),n=e.getMonth()+1;return e.getFullYear()+"-"+(n<10?"0":"")+n+"-"+(t<10?"0":"")+t}});var Dialog=new Class({Implements:[Events,Options],options:{cssShow:"show",styles:{},relativeTo:document.body},initialize:function(e){var t=this,n;this.setClass(".dialog",e),this.setOptions(e),console.log("DIALOG Initialize ",this.options.cssClass),e=t.options,n=t.element=e.dialog||t.build(e),n.getElements(".close").addEvent("click",t.hide.bind(t)),n.getStyle("position")=="absolute"&&e.draggable&&new Drag(n,{handle:(t.get(".caption")||n).setStyle("cursor","move")}),t[e.showNow?"show":"hide"]()},toElement:function(){return this.element},get:function(e){return this.element.getElement(e)},setClass:function(e,t){t.cssClass=e+(t.cssClass||"")},destroy:function(){this.element.destroy()},show:function(){return console.log("DIALOG show",this.options.cssClass,this.element.className),this.fireEvent("beforeOpen",this).setPosition().element.addClass(this.options.cssShow),this.fireEvent("open",this)},hide:function(){return this.fireEvent("beforeClose",this).element.removeClass(this.options.cssShow),this.fireEvent("close",this)},isVisible:function(){return this.element.hasClass(this.options.cssShow)},toggle:function(){return this[this.isVisible()?"hide":"show"]()},action:function(e){this.fireEvent("action",e),this.options.autoClose&&this.hide()},build:function(e){var t=this.element=["div"+e.cssClass,{styles:e.styles},["a.close",{html:"&#215;"},"div.body"]].slick().inject(document.body);return e.relativeTo&&t.inject($(e.relativeTo),"before"),console.log("DIALOG build ",this.element.className),this.setBody(e.body),e.caption&&this.setCaption(e.caption),console.log("DIALOG build ",this.element.className),t},setBody:function(e){var t=this.get(".body")||this.element,n=typeOf(e);return t.empty(),n=="string"&&t.set("html",e),n=="element"&&t.adopt(e),n=="elements"&&t.adopt(e),this},setCaption:function(e){var t=this.get(".caption")||"div.caption".slick().inject(this.element,"top");return type=typeOf(e),t.empty(),type=="string"&&t.set("html",e),type=="element"&&t.adopt(e),this},setValue:function(e){return console.log("DIALOG  "+e),this.setBody(e)},setPosition:function(e){var t=window,n,r,i,s,o=this.element;return e||(e=this.options.relativeTo),s=e&&"getCoordinates"in e?e:document.id(e),o.getStyle("position")=="absolute"&&(s?(s=s.getCoordinates(),r=s.left,i=s.bottom):(n=t.getScroll(),t=t.getSize(),s=o.getCoordinates(),r=n.x+t.x/2-s.width/2,i=n.y+t.y/2-s.height/2),o.setPosition({x:r,y:i})),this}});Dialog.Buttons=new Class({Extends:Dialog,options:{buttons:[],autoClose:!0},initialize:function(e){this.setClass(".buttons",e),console.log("Dialog.Buttons",e),this.parent(e),this.setButtons(this.options.buttons)},setButtons:function(e){var t=this,n=t.get(".btn-group")||"div.btn-group".slick().inject(t.element);return n.empty().adopt(e.map(function(e){return"a.btn.btn-link.btn-sm".slick({html:e.localize(),events:{click:t.action.bind(t,e)}})})),t}}),Dialog.Color=new Class({Extends:Dialog,options:{color:"#ffffff",resize:{x:[96,256]}},initialize:function(e){var t=this,n,r=e.showNow,i=t.setHSV.bind(this);this.setClass(".color",e),e.caption="span.color".slick(),e.body=["div.cursor","div.zone"].slick(),n=t.cursor=e.body[0],e.showNow=!1,t.parent(e),new Drag(n,{handle:n.getNext(),style:!1,snap:0,onStart:i,onDrag:i}),t.setValue(),r&&t.show()},setValue:function(e){return e=(e||this.options.color).hexToRgb(!0)||[255,255,255],this.hsv=e.rgb2hsv(),this.moveCursor()},setHSV:function(e,t){var n=this,r=n.get(".body").getCoordinates(),i=[t.page.x-r.left,t.page.y-r.top],s=r.width,o=s/2,u=o/2,a=i[0]-o,f=s-i[1]-o,l=Math.sqrt(Math.pow(a,2)+Math.pow(f,2)),c=Math.atan2(a,f)/(Math.PI*2);n.hsv=[c>0?c*360:c*360+360,l<u?l/u*100:100,l>=u?Math.max(0,1-(l-u)/u)*100:100],n.moveCursor(),n.fireEvent("drag",n.getHex())},getHex:function(){return this.hsv.hsv2rgb().rgbToHex()},action:function(e){this.parent(this.getHex())},show:function(){return this.parent().moveCursor()},moveCursor:function(){var e=this,t=e.hsv,n=e.getHex(),r=e.get(".body").getSize().x/2,i=t[0]/360*Math.PI*2,s=(t[1]+(100-t[2]))/100*(r/2);return e.get(".color").set({html:n,styles:{color:(new Color(n)).invert().hex,background:n}}),e.cursor.setStyles({left:Math.abs(Math.sin(i)*s+r),top:Math.abs(Math.cos(i)*s-r)}),e}}),Dialog.Selection=new Class({Extends:Dialog,options:{cssClass:"dialog selection",autoClose:!0,items:".body li"},initialize:function(e){this.setClass(".selection",e),this.selected=e.selected||"",this.parent(e),console.log("Dialog.Selection ",this.element.className)},setBody:function(e){var t=this;return console.log("Dialog.Selection body ",e),e||(e=t.options.body),typeOf(e)=="string"&&(e=e.split("|")),typeOf(e)=="array"&&(e=e.associate(e)),typeOf(e)=="object"&&(e="ul".slick({html:Object.keys(e).map(function(t){return'<li title="'+t+'">'+e[t]+"</li>"})})),typeOf(e)=="element"&&(t.parent(e).setValue(t.selected),t.getItems().addEvents({click:function(){t.action(this)},mouseleave:function(){this.removeClass("hover")},mouseenter:function(){this.addClass("hover")}})),t},setValue:function(e){var t="selected",n;return n=this.get("."+t),n&&n.removeClass(t),n=this.getItems("[title^="+e+"]"),n[0]&&n[0].addClass(t),this[t]=e,this},getValue:function(){return this.selected},action:function(e){var t=e.get("title");this.setValue(t).parent(t)},getItems:function(e){return this.element.getElements(this.options.items+(e||""))}}),Dialog.Font=new Class({Extends:Dialog.Selection,options:{fonts:{arial:"Arial","comic sans ms":"Comic Sans","courier new":"Courier New",garamond:"Garamond",georgia:"Georgia",helvetica:"Helvetica",impact:"Impact","times new roman":"Times",tahoma:"Tahoma","trebuchet ms":"Trebuchet",verdana:"Verdana"}},initialize:function(e){var t=this,n=e.fonts;this.setClass(".font",e),e.body=n?n:t.options.fonts,t.parent(e),t.getItems().each(function(e){e.setStyle("font-family",e.get("title"))})}}),Dialog.Chars=new Class({Extends:Dialog.Selection,options:{items:".body td",chars:["nbsp|iexcl|cent|pound|curren|yen|brvbar|sect|uml|copy|ordf","laquo|not|reg|macr|deg|plusmn|sup2|sup3|acute|micro|para","middot|cedil|sup1|ordm|raquo|frac14|frac12|frac34|iquest|times|divide","Agrave|Aacute|Acirc|Atilde|Auml|Aring|AElig|Ccedil|Egrave|Eacute|Ecirc","Euml|Igrave|Iacute|Icirc|Iuml|ETH|Ntilde|Ograve|Oacute|Ocirc|Otilde","Ouml|Oslash|Ugrave|Uacute|Ucirc|Uuml|Yacute|THORN|szlig|agrave|aacute","acirc|atilde|auml|aring|aelig|ccedil|egrave|eacute|ecirc|euml|igrave","iacute|icirc|iuml|eth|ntilde|ograve|oacute|ocirc|otilde|ouml|oslash","ugrave|uacute|ucirc|uuml|thorn|yuml|OElig|oelig|Scaron|scaron|Yuml","ndash|mdash|lsquo|rsquo|ldquo|rdquo|dagger|Dagger|bull|hellip|permil","euro|trade|larr|uarr|rarr|darr|harr|crarr|loz|diams|infin"]},initialize:function(e){this.setClass(".chars",e),this.parent(e)},setBody:function(){var e=this.options.chars.map(function(e){return"<tr>"+e.split("|").map(function(e){return'<td title="&amp;'+e+';">&'+e+";</td>"}).join("")+"</tr>"});return this.parent("table".slick({html:"<tbody>"+e.join("")+"</tbody>"}))}}),Dialog.Find=new Class({Extends:Dialog,Binds:["find","replace"],options:{draggable:!0,controls:{f:"[name=tbFIND]",r:"[name=tbREPLACE]",h:".tbHITS",re:"[name=tbREGEXP]",i:"[name=tbMatchCASE]",one:"[name=replace]",all:"[name=replaceall]"},data:{get:function(){},set:function(){}}},initialize:function(e){var t=this.setOptions(e),n=t.options.dialog,r;this.setClass(".find",e),r=t.controls=Object.map(t.options.controls,function(e){return n.getElement(e)}),t.parent(e),console.log("Dialog.Find initialize:",r),r.f.addEvents({keyup:t.find,focus:t.find}),n.addEvents({"change:relay([type=checkbox])":function(){r.f.focus()},"click:relay(button)":t.replace})},show:function(){this.parent(),this.controls.f.focus()},find:function(){var e=this,t=e.controls,n=t.f,r=t.h,i=n.value,s="";i!=""&&(s=e.buildRE(i),typeOf(s)=="regexp"&&(s=e.options.data.get().match(e.buildRE(i,!0)),s&&(s=s.length))),r&&r.set("html",s),t.r.ifClass(!s,"disabled"),t.one.ifClass(!s,"disabled"),t.all.ifClass(!s,"disabled"),n.focus()},replace:function(e){var t=this,n=t.controls,r=n.r,i=n.f,s=t.options.data;s.set(s.get().replace(t.buildRE(i.value,e.target==n.all),r?r.value:"")),i.focus()},buildRE:function(e,t){var n=this.controls,r=n.re&&n.re.checked,i=t?"g":"",s=n.i&&n.i.checked?"":"i";try{return RegExp(r?e:e.escapeRegExp(),i+s+"m")}catch(o){return"<span title='"+o+"'>!#@</span>"}}});var Textarea=new Class({Implements:[Options,Events],initialize:function(e,t){var n=this,r=n.ta=$(e),i,s=-1,o=function(e){var t=r.value;if(t.length!=s||t!==i)n.fireEvent("change",e),s=t.length,i=t};return n.setOptions(t),r.addEvents({change:o,keyup:o}),n.taShadow=(new Element("div[style=position:absolute;visibility:hidden;overflow:auto]")).inject(r,"before").setStyles(r.getStyles("font-family0font-size0line-height0text-indent0padding-top0padding-right0padding-bottom0padding-left0border-left-width0border-right-width0border-left-style0border-right-style0white-space0word-wrap".split(0))),this},toElement:function(){return this.ta},getValue:function(){return this.ta.value},slice:function(e,t){return this.ta.value.slice(e,t)},getFromStart:function(){return this.slice(0,this.getSelectionRange().start)},getTillEnd:function(){return this.slice(this.getSelectionRange().end)},getSelection:function(){var e=this.getSelectionRange();return this.slice(e.start,e.end)},setSelectionRange:function(e,t){var n=this.ta,r,i,s;return t||(t=e),n.setSelectionRange?n.setSelectionRange(e,t):(r=n.value,i=r.slice(e,t-e).replace(/\r/g,"").length,e=r.slice(0,e).replace(/\r/g,"").length,s=n.createTextRange(),s.collapse(1),s.moveEnd("character",e+i),s.moveStart("character",e),s.select()),this},getSelectionRange:function(){var e=this.ta,t={start:0,end:0},n,r,i,s;return e.selectionStart!=null?t={start:e.selectionStart,end:e.selectionEnd}:(n=document.selection.createRange(),n&&n.parentElement()==e&&(r=n.duplicate(),i=e.value,s=i.length-i.match(/[\n\r]*$/)[0].length,r.moveToElementText(e),r.setEndPoint("StartToEnd",n),t.end=s-r.text.length,r.setEndPoint("StartToStart",n),t.start=s-r.text.length)),t.thin=t.start==t.end,t},setSelection:function(){var e=Array.from(arguments).join("").replace(/\r/g,""),t=this.ta,n=t.scrollTop,r,i,s,o;return t.selectionStart!=null?(r=t.selectionStart,i=t.selectionEnd,s=t.value,t.value=s.slice(0,r)+e+s.substr(i),t.selectionStart=r,t.selectionEnd=r+e.length):(t.focus(),o=document.selection.createRange(),o.text=e,o.collapse(1),o.moveStart("character",-e.length),o.select()),t.focus(),t.scrollTop=n,t.fireEvent("change"),this},insertAfter:function(){var e=Array.from(arguments).join("");return this.setSelection(e).setSelectionRange(this.getSelectionRange().start+e.length)},isCaretAtStartOfLine:function(){var e=this.getSelectionRange().start;return e<1||this.ta.value.charAt(e-1).test(/[\n\r]/)},getCoordinates:function(e){var t=this.ta,n=this.taShadow,r=0,i,s,o,u,a,f,l;s=t.getStyles(["padding-left","padding-right","border-left-width","border-right-width"]);for(o in s)r+=s[o].toInt();return e||(e=this.getSelectionRange().end),i=n.set({styles:{width:t.offsetWidth-r,height:t.getStyle("height")},html:t.value.slice(0,e)+"<i>A</i>"+t.value.slice(e+1)}).getElement("i"),u=t.offsetTop+i.offsetTop-t.scrollTop,a=t.offsetLeft+i.offsetLeft-t.scrollLeft,f=i.offsetWidth,l=i.offsetHeight,{top:u,left:a,width:f,height:l,right:a+f,bottom:u+l}}}),UndoRedo=new Class({Implements:Options,options:{maxundo:40},initialize:function(e,t){var n=this,r=this.btn={redo:t.redo,undo:t.undo};n.setOptions(t),n.obj=e,n.redo=[],n.undo=[],n.btnStyle()},onChange:function(e){var t=this;t.undo.push(e||t.obj.getState()),t.redo=[],t.undo[t.options.maxundo]&&t.undo.shift(),t.btnStyle()},onUndo:function(e){var t=this;e&&e.stop(),t.undo[0]&&(t.redo.push(t.obj.getState()),t.obj.putState(t.undo.pop())),t.btnStyle()},onRedo:function(e){var t=this;e&&e.stop(),t.redo[0]&&(t.undo.push(t.obj.getState()),t.obj.putState(t.redo.pop())),t.btnStyle()},btnStyle:function(){var e=this,t=e.btn;t.undo&&t.undo.ifClass(!e.undo[0],"disabled"),t.redo&&t.redo.ifClass(!e.redo[0],"disabled")}}),Snipe=new Class({Implements:[Options,Events],Binds:["sync","shortcut","keystroke","suggest"],options:{tab:"    ",snippets:{},directsnips:{},sectionCursor:"all",sectionParser:function(){return{}}},initialize:function(e,t){t=this.setOptions(t).options;var n=this,r=n.mainarea=$(e),i=r.clone().erase("name").inject(r.hide(),"before"),s=t.container||i.form;textarea=n.textarea=new Textarea(i),n.undoredo=new UndoRedo(n,{undo:s.getElement("[data-cmd=undo]"),redo:s.getElement("[data-cmd=redo]")}),n.commands=new Snipe.Commands(s,{onOpen:function(){},onClose:function(){i.focus()},onAction:function(e){n.action(e,Array.slice(arguments,1))},dialogs:{find:[Dialog.Find,{data:{get:function(){var e=textarea.getSelection();return e==""?i.value:e},set:function(e){var t=textarea.getSelectionRange();n.undoredo.onChange(),t.thin?i.value=e:textarea.setSelection(e)}}}]}}),n.initSnippets(t.snippets),n.clearContext(),i.addEvents({keydown:n.keystroke,keypress:n.keystroke,keyup:n.suggest,click:n.suggest,change:function(e){n.fireEvent("change",e)}}),s.addEvent("keypress",n.shortcut)},initSnippets:function(e){var t=this,n,r,i,s={},o=Browser.Platform.mac,u=o?"meta+":"control+";t.keys={},t.suggestions={};for(n in e){r=e[n],typeOf(r)=="string"&&(r={snippet:r}),Function.from(r.initialize)(n,r);if(i=r.key)i.indexOf("+")<0&&(i=u+i),t.keys[i.toLowerCase()]=n;typeOf(r.suggest)=="function"&&(t.suggestions[n]=r),r[n]&&(s[n]=r[n])}console.log("snip dialogs",Object.keys(s).length),t.commands.addDialogs(s,t.textarea)},toElement:function(){return $(this.textarea)},get:function(e){return/mainarea|textarea/.test(e)?this[e]:/snippets|directsnips|autosuggest|tabcompletion|smartpairs/.test(e)?this.options[e]:null},set:function(e,t){return/snippets|directsnips|autosuggest|tabcompletion|smartpairs/.test(e)&&(this.options[e]=t),this},shortcut:function(e){var t=(e.shift?"shift+":"")+(e.control?"control+":"")+(e.meta?"meta+":"")+(e.alt?"alt+":"")+e.key,n=this.keys[t];n&&(console.log(this.keys,"shortcut",t,n),e.stop(),this.commands.action(n))},keystroke:function(e){if(e.type=="keydown"){if(e.key.length==1)return}else{if(!e.event.which)return;e.key=String.fromCharCode(e.code).toLowerCase()}var t=this,n=t.textarea,r=$(n),i=e.key,s=n.getSelectionRange(),o=r.getScroll();r.focus(),/up|down|esc/.test(i)?t.clearContext():/tab|enter|delete|backspace/.test(i)?t[i](e,n,s):t.directSnippet(e,n,s),r.scrollTo(o)},enter:function(e,t,n){this.clearContext();if(n.thin){var r=t.getFromStart().split(/\r?\n/).pop(),i=r.match(/^\s+/);i&&i!=r&&(e.stop(),t.insertAfter("\n"+i[0]))}},backspace:function(e,t,n){if(n.thin&&n.start>0){var r=t.getValue().charAt(n.start-1),i=this.getSnippet(this.options.directsnips,r);i&&i.snippet==t.getValue().charAt(n.start)&&t.setSelectionRange(n.start,n.start+1).setSelection("")}},"delete":function(e,t,n){var r=this.options.tab;n.thin&&!t.getTillEnd().indexOf(r)&&(e.stop(),t.setSelectionRange(n.start,n.start+r.length).setSelection(""))},tab:function(e,t,n){var r=this,i=r.options.snippets,s=t.getFromStart(),o=s.length,u,a;e.stop();if(r.options.tabcompletion){if(r.hasContext())return r.nextAction(t,n);if(n.thin)for(u in i){a=u.length;if(o>=a&&u==s.slice(-a))return t.setSelectionRange(n.start-a,n.start).setSelection(""),r.commands.action(u)}}r.convertTabToSpaces(e,t,n)},convertTabToSpaces:function(e,t,n){var r=this.options.tab,i=t.getSelection(),s=t.getFromStart();isCaretAtStart=t.isCaretAtStartOfLine(),i.indexOf("\n")>-1?(isCaretAtStart&&(i="\n"+i),e.shift?i=i.replace(RegExp("\n"+r,"g"),"\n"):i=i.replace(/\n/g,"\n"+r),t.setSelection(isCaretAtStart?i.slice(1):i)):e.shift?s.test(r+"$")&&t.setSelectionRange(n.start-r.length,n.start).setSelection(""):t.setSelection(r).setSelectionRange(n.start+r.length)},hasContext:function(){return!!this.context.snip},setContext:function(e,t){this.context={snip:e,suggest:t},$(this).addClass("activeSnip")},clearContext:function(){this.context={},this.commands.close(),$(this).removeClass("activeSnip").focus()},getSnippet:function(e,t){var n=this,r=n.textarea,i=r.getFromStart(),s=e[t],o=this.options.tab,u=[],a,f;s&&s.synonym&&(s=e[s.synonym]),s=Function.from(s)(n,[t]),typeOf(s)=="string"&&(s={snippet:s});if(!s||!n.inScope(s,i))return!1;a=s.snippet||"",a=a.replace(/\\?\{([^{}]+)\}/g,function(e,t){return e.charAt(0)=="\\"?e.slice(1):(u.push(t),t)}).replace(/\\\{/g,"{"),f=u.getLast(),f&&u.push(a.slice(a.lastIndexOf(f)+f.length)),a.test(/^\n/)&&i.test(/(^|[\n\r]\s*)$/)&&(a=a.slice(1)),a.test(/\n$/)&&r.getTillEnd().test(/^\s*[\n\r]/)&&(a=a.slice(0,-1));var l=i.split(/\r?\n/).pop(),c=l.match(/^\s+/);return c&&(a=a.replace(/\n/g,"\n"+c[0])),s.text=a,s.parms=u,s},inScope:function(e,t){var n,r,i=e.scope,s=e.nscope;if(i){if(typeOf(i)=="function")return i(this.textarea);for(n in i){r=t.lastIndexOf(n);if(r>-1&&t.indexOf(i[n],r)==-1)return 1}return!1}if(s)for(n in s){r=t.lastIndexOf(n);if(r>-1&&t.indexOf(s[n],r)==-1)return!1}return 1},directSnippet:function(e,t,n){var r=this,i=r.options,s=r.getSnippet(i.directsnips,e.key);s&&i.smartpairs&&(e.stop(),t.setSelection(e.key,t.getSelection(),s.snippet).setSelectionRange(n.start+1,n.end+1))},action:function(e,t){var n=this,r=n.textarea,i=r.getSelectionRange(),s=n.context.snip||n.getSnippet(n.options.snippets,e),o;if(s){o=s.text;if(s.action)return s.action.call(n,e,s,t);n.undoredo.onChange();if(s.event)return n.fireEvent(s.event,[e,t]);$(r).focus();if(n.options.autosuggest&&n.context.suggest)return n.suggestAction(e,t);!i.thin&&s.parms.length==2&&(o=n.toggleSnip(r,s,i)),t&&t.each(function(e){s.parms.length>1&&(o=o.replace(s.parms.shift(),e))}),!i.thin&&s.parms[1]&&(o=o.replace(s.parms.shift(),r.getSelection())),r.setSelection(o),s.parms.length?(n.hasContext()||n.setContext(s),i=r.getSelectionRange(),n.nextAction(r,i)):(i.thin&&r.setSelectionRange(i.start+o.length),n.clearContext())}},toggleSnip:function(e,t,n){var r=t.text,i=r.trim().split(t.parms[0]),s=i[0],o=i[1],u=new RegExp("^\\s*"+s.trim().escapeRegExp()+"\\s*(.*)\\s*"+o.trim().escapeRegExp()+"\\s*$");return s+o!=""&&(r=e.getSelection(),t.parms=[],r.test(u)?r=r.replace(u,"$1"):e.getFromStart().test(s+"$")&&e.getTillEnd().test("^"+o)?e.setSelectionRange(n.start-s.length,n.end+o.length):e.setSelection(s+o).setSelectionRange(n.start+s.length)),r},suggest:function(){var e=this,t=e.textarea,n=t.getSelectionRange(),r=t.getFromStart(),i=e.suggestions,s,o,u;if(!e.options.autosuggest)return;for(s in i){u=i[s],o=u.suggest(t,n);if(o)return o.tail||(o.tail=0),e.setContext(u,o),e.commands.action(s,o.match)}this.clearContext()},suggestAction:function(e,t){var n=this,r=n.textarea,i=n.context.suggest,s=i.start+i.match.length+i.tail;return r.setSelectionRange(i.start,s).setSelection(t),i.tail>0&&r.setSelectionRange(s-i.tail,r.getSelectionRange().end),n.clearContext(),n.suggest()},nextAction:function(e,t){var n=this,r=n.context.snip,i=r.parms,s,o;while(i[0]){s=i.shift(),o=e.getValue().indexOf(s,t.start);if(s!=""&&o>-1){if(i[0]){e.setSelectionRange(o,o+s.length),n.commands.action(s,r[s]),n.undoredo.onChange();return}e.setSelectionRange(o+s.length)}}n.clearContext()},getState:function(){var e=this.textarea,t=$(e);return{main:this.mainarea.value,value:t.get("value"),cursor:e.getSelectionRange(),scrollTop:t.scrollTop,scrollLeft:t.scrollLeft}},putState:function(e){var t=this,n=t.textarea,r=$(n);t.clearContext(),t.mainarea.value=e.main,r.value=e.value,r.scrollTop=e.scrollTop,r.scrollLeft=e.scrollLeft,n.setSelectionRange(e.cursor.start,e.cursor.end).fireEvent("change",[e.value])}});Snipe.Commands=new Class({Implements:[Events,Options],options:{cmds:"cmd"},btns:{},dlgs:{},dialogs:{},initialize:function(e,t){var n=this.setOptions(t),r="data-"+n.options.cmds,i,s,o=t.dialogs||{};e.getElements("["+r+"]").each(function(t){i=t.get(r),n.btns[i]=t.addEvent("click",n.click.pass(i,n));if(s=e.getElement(".dialog."+i))o[i]?o[i][1].dialog=s:o[i]=s}),n.addDialogs(o)},addDialogs:function(e,t){var n=this,r,i;dialogs=n.dialogs;for(i in e)dialogs&&dialogs[i]&&console.log("AddDialogs - warning: double registration of => "+i),r=dialogs[i]=e[i],instanceOf(r,Dialog)&&n.attach(i,r),t&&(n.btns[i]=t)},attach:function(e,t){var n=this,r=function(t){n.fireEvent("action",[e,t])};return n.dlgs[e]=t.addEvents({onOpen:n.openDialog.bind(n,e),onClose:n.closeDialog.bind(n,e),onAction:r,onDrag:r})},click:function(e){var t=this.dlgs[e];t?t.toggle():this.action(e)},action:function(e,t){var n=this,r="active",i=n.btns[e],s=n.dlgs[e];i&&(i=document.id(i));if(!i||!i.match(".disabled"))n.dialogs[e]?(s||(s=n.createDialog(e)),t&&s.setValue(t),s.show()):(i&&i.addClass(r),n.fireEvent("action",[e,t]),i&&i.removeClass(r))},createDialog:function(e){var t=this,n,r=t.btns[e],i=Function.from(t.dialogs[e])(),s=typeOf(i);if(s!="array"||i.length!=2)i=s=="element"?[Dialog,{dialog:i}]:[Dialog.Selection,{body:i}];return n=new i[0](Object.append(i[1],{autoClose:!1,relativeTo:r})),t.attach(e,n)},openDialog:function(e,t){var n=this,r=n.activeCmd,i;r!=e&&(i=n.dlgs[r])&&i.hide(),n.activeCmd=e,(i=n.btns[e])&&$(i).addClass("active"),n.fireEvent("open",e,t)},closeDialog:function(e,t){var n=this,r=n.btns[e];e==n.activeCmd&&(n.activeCmd=null),r&&$(r).removeClass("active"),n.fireEvent("close",e,t)},close:function(){var e=this.activeCmd;e&&this.dlgs[e].hide()}}),Snipe.Sections=new Class({Implements:[Events],Binds:["show","update","action"],options:{all:"( all )".localize(),startOfPage:"Start of Page".localize()},initialize:function(e,t){var n=this;n.element=e.onHover(n.container=e.get("data-sections"),n.show).addEvent("click:relay(a)",n.action),n.container=e.getParent(e.get("data-sections")),n.parser=t.parser,n.main=t.snipe.get("mainarea"),n.work=t.snipe.toElement().addEvents({keyup:n.update,change:n.update}),n.parse(),n.action(location.search),n.show()},parse:function(){this.sections=this.parser(this.main.value)},show:function(){var e=this.options,t=[],n=this.sections,r=function(e,n,r){t.push("li",["a.indent-"+e+".section"+r,{html:n}])};r(0,e.all,-2),n[0]&&(n[0].start>0&&r(0,e.startOfPage,-1),t.push("li.divider"),n.each(function(e,t){r(e.depth,e.title.trunc(36),t)})),this.element.empty().adopt(t.slick())},update:function(){var e=this,t=e.main,n=e.work.value,r=e.sections,i=t.value,s=n.slice(-1)!="\n"?"\n":"";t.value=i.slice(0,e.begin)+n+s+i.slice(e.end),e.end=e.begin+n.length,e.parse()},action:function(e){var t=this,n=t.main.value,r=t.sections,i=0,s=n.length;e&&(e.target&&(e=e.target.className),e=(e.match(/section=?(-?\d+)/)||[,-2])[1].toInt(),e==-1?s=r[0].start:e>=0&&r[e]&&(i=r[e].start,r[e+1]&&(s=r[e+1].start))),t.work.value=n.slice(i,s),t.begin=i,t.end=s,t.container.removeClass("open"),t.container.ifClass(e>=-1,"section-selected")}}),Wiki.DirectSnips={'"':'"',"(":")","[":"]","{":"}","%%":" /%","'":{snippet:"'",scope:{"[{":"}]"}}},Wiki.Snips={find:{key:"f"},undo:{action:function(){this.undoredo.onUndo()},key:"z"},redo:{action:function(){this.undoredo.onRedo()},key:"y"},smartpairs:{event:"config"},livepreview:{event:"config"},autosuggest:{event:"config"},tabcompletion:{event:"config"},previewcolumn:{event:"config"},br:{key:"shift+enter",snippet:"\\\\\n"},hr:"\n----\n",h:{xxxsuggest:function(e,t){var n,r=e.slice(0,t.start).match(/(?:^|[\n\r])(!{1,3}[^\n\r]*)$/);return r&&(n=r[1],r={start:t.start-n.length,match:n+e.slice(t.start).match(/[^\n\r]*/)||""}),r},h:[Dialog.Selection,{onOpen:function(){var e=this.getValue().replace(/^!+\s?/,"")||"Title",t=e.trim().trunc(20),n=["!!! "+e,"!! "+e,"! "+e],r=["<h2>"+t+"</h2>","<h3>"+t+"</h3>","<h4>"+t+"</h4>"];this.setBody(r.associate(n))}}]},font:{nScope:{"%%(":")","font-family:":";"},snippet:"%%(font-family:{font};) {.}/% ",font:[Dialog.Font,{}]},color:{nscope:{"%%(":")"},snippet:"%%(color:{#000000}; background:{#ffffff};) {.} ",suggest:function(e,t){var n,r,i=e.slice(0,t.end).match(/#[0-9a-f]{0,6}$/i);return i&&(n=i[0],r=e.slice(t.end).match(/^[0-9a-f]+/i)||"",i={start:t.end-n.length,match:(n+r).slice(0,7)}),i},color:[Dialog.Color,{}]},symbol:{synonym:"chars"},chars:{nScope:{"%%(":")"},snippet:"{&entity;}",suggest:function(e,t){var n,r=e.slice(0,t.end).match(/&[\da-zA-Z]*;?$/);return r&&(n=r[0],r={start:t.end-n.length,match:n,tail:e.slice(t.end).match(/^[\da-zA-Z]*;?/)||""}),r},chars:[Dialog.Chars,{caption:"Special Chars".localize()}]},style:{synonym:"css"},css:{nScope:{"%%(":")"},snippet:"%%{css} {.} /% ",suggest:function(e,t){var n,r=e.slice(0,t.end).match(/%%[\da-zA-Z(\-\_:#;)]*$/);return r&&(n=r[0].slice(2),r={start:t.end-n.length,match:n+e.slice(t.end).match(/^[\da-zA-Z(:#;)]*/)||""}),r},css:{"(css:value;)":"any css definitions","text-success":"text-success","text-information":"text-information","text-warning":"text-warning","text-error":"text-error",success:"success",information:"information",warning:"warning",error:"error",commentbox:"commentbox",quote:"quoted paragraph",sub:"sub-script<span class='sub'>2</span>",sup:"super-script<span class='sup'>2</span>",strike:"<span class='strike'>strikethrough</span>",pretify:"prettify code block",reflection:"image reflection"}},sub:"%%sub {subscript text}/% ",sup:"%%sup {superscript text}/% ",strike:"%%strike {strikethrough text}/% ",xflow:"\n%%xflow\n{wide content}\n/%\n ",quote:"\n%%quote \n{quoted text}\n/%\n",dl:"\n;{term}:{definition-text} ",pre:"\n\\{\\{\\{\n{some preformatted block}\n}}}\n",code:"\n%%prettify \n\\{\\{\\{\n{/* some code block */}\n}}}\n/%\n",mono:"\\{\\{{monospaced text}}} ",link:{key:"l",commandIdentifier:"createlink",suggest:function(e,t){var n=e.getFromStart().match(/\[([^\[\{\]\n\r]*)$/),r;return n&&(r=n[1].split("|").getLast(),n={start:t.start-r.length,match:r,tail:e.slice(t.start).search(/[\n\r\]]/)}),n},snippet:"[{link}] ",link:[Dialog.Selection,{onOpen:function(e){var e=this,t=e.getValue();if(!t||t.trim()=="")t=Wiki.PageName+"/";Wiki.jsonrpc("search.getSuggestions",[t,30],function(t,n){t.list&&t.list[0]?e.setBody(t.list):e.hide()})}}]},bold:{key:"b",snippet:"__{bold text}__ "},italic:{key:"i",snippet:"''{italic text}'' "},allow:{synonym:"acl"},acl:{snippet:"\n[\\{ALLOW {permission} {principal(,principal)} \\}]\n",permission:"view|edit|modify|comment|rename|upload|delete","principal(,principal)":function(){return"Anonymous|Asserted|Authenticated|All"}},img:{snippet:"\n[\\{Image src='{img.jpg}' width='{400px}' height='{300px}' align='{text-align}' style='{css-style}' class='{css-class}' }]\n ","text-align":"left|center|right"},plugin:{snippet:"\n[\\{{plugin}}]\n",suggest:function(e,t){},plugin:{"TableOfContents title='Page contents' numbered='true' prefix='Chap. '":"Table Of Contents (toc)","If name='value' page='pagename' exists='true' contains='regexp'\n\nbody\n":"Test a page variable","SET alias='{pagename}'":"Make a Page Alias","SET name='value'":"Set a page variable",$varname:"Get a page variable","InsertPage page='pagename'":"Insert Page","CurrentTimePlugin format='yyyy mmm-dd'":"Current Time","Search query='Janne' max='10'":"Search query","ReferredPagesPlugin page='pagename' type='local|external|attachment' depth='1..8' include='regexp' exclude='regexp'":"Incoming Links (aka referred pages)","ReferringPagesPlugin page='pagename' separator=',' include='regexp' exclude='regexp'":"Outgoing Links (aka referring pages)","WeblogPlugin page='pagename' startDate='300604' days='30' maxEntries='30' allowComments='false'":"Display weblog posts",WeblogEntryPlugin:"New weblog entry"}},tab:{nScope:{"%%(":")","%%tabbedSection":"/%"},snippet:"%%tabbedSection \n%%tab-{tabTitle1}\n{tab content 1}\n/%\n%%tab-{tabTitle2}\n{tab content 2}\n/%\n/%\n "},toc:{nScope:{"[{":"}]"},snippet:"\n[\\{TableOfContents }]\n"},table:"\n||heading-1||heading-2\n| cell11   | cell12\n| cell21   | cell22\n",me:{alias:"sign"},sign:function(){var e=Wiki.UserName||"UserName";return"\\\\\n--"+e+", "+(new Date).toISOString()+"\\\\\n"},date:function(e){return(new Date).toISOString()+" "},abra:{suggest:"abra",snippet:"cadabra"},abrar:{suggest:"abrar",snippet:"acurix"},lorem:"This is is just some sample. Don’t even bother reading it; you will just waste your time. Why do you keep reading? Do I have to use Lorem Ipsum to stop you? OK, here goes: Lorem ipsum dolor sit amet, consectetur adipi sicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Still reading? Gosh, you’re impossible. I’ll stop here to spare you.",Lorem:{synonym:"lorem"}},!function(e){function u(e){window.onbeforeunload=function(){if(e.value!=e.defaultValue)return"edit.areyousure".localize()},e.getParent("form").addEvent("submit",function(){window.onbeforeunload=null})}function a(t,n){function f(e){t.ifClass(e,"dragging")}var s="height",o=r.toElement(),u=e.get(n),a;u&&(o.setStyle(s,u),i.setStyle(s,u)),t&&o.makeResizable({handle:t,modifiers:{x:null},onDrag:function(){a=this.value.now.y,i.setStyle(s,a),e.set(n,a)},onBeforeStart:f.pass(!0),onComplete:f.pass(!1),onCancel:f.pass(!1)})}function f(t){var n=r.toElement().get("value");$("livepreview").checked?s!=n.length&&(s=n.length,(new Request.HTML({url:e.XHRPreview,data:{page:e.PageName,wikimarkup:n},update:i,onRequest:function(){i.addClass("loading")},onComplete:function(){i.removeClass("loading"),e.update()}})).send()):s&&(i.empty(),s=null)}function l(n){var s=t.getElement("[data-cmd="+n+"]"),o,u;s&&(e.set(n,o=s.checked),n.test(/livepreview|previewcolumn/)&&(u=t.getElement(".edit-area").ifClass(o,n),n=="livepreview"?t.getElement("[data-cmd=previewcolumn]").disabled=!o:o?u.adopt(i):i.inject(t.getElement(".resizer"),"after")),r.set(n,o).fireEvent("change"))}function c(e){var t=[],n="¤",r=e.replace(/\{\{\{([\s\S]*?)\}\}\}/g,function(e){return e.replace(/^!/mg," ")}).replace(/^([!]{1,3})/mg,n+"$1"+n).split(n),i=r.shift().length,s=r.length,o,u,a;for(o=0;o<s;o+=2)u=r[o].length,a=r[o+1].split(/[\r\n]/)[0].replace(/(^|[^~])(__|''|\{\{|\}\}|%%\([^\)]+\)|%%\S+\s|%%\([^\)]+\)|\/%)/g,"$1").replace(/~([^~])/g,"$1"),t.push({title:a,start:i,depth:3-u}),i+=u+r[o+1].length;return t}var t,n,r,i,s,o;e.add("#editform",function(s){t=s,n=t.getElement(".editor"),i=t.getElement(".ajaxpreview"),o=t.getElement("[data-sections]"),u(n),r=new Snipe(n,{snippets:e.Snips,directsnips:e.DirectSnips,onChange:i?f:null,onConfig:l}),e.Context=="edit"&&o&&new Snipe.Sections(o,{snipe:r,parser:c}),a(s.getElement(".resizer"),"EditorCookie"),["tabcompletion","smartpairs","autosuggest","livepreview","previewcolumn"].each(function(n){var r=t.getElement("[data-cmd="+n+"]");r&&(r.checked=!!e.get(n),l(n))})})}(Wiki)